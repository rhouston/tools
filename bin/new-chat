#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: new-chat [--repo NAME_OR_PATH | --scratch] [--shared-instance]

Options:
  --repo NAME_OR_PATH  Open a repo by name from ~/library/repositories or by full path.
  --scratch            Open a neutral folder (~/library or ~/Library).
  --shared-instance    Reuse the normal VS Code user-data dir (disables per-window isolation).
  --help               Show this help message.
USAGE
}

resolve_existing_dir() {
  local dir
  for dir in "$@"; do
    if [[ -d "$dir" ]]; then
      printf '%s\n' "$dir"
      return 0
    fi
  done
  return 1
}

json_escape() {
  local s="$1"
  s="${s//\\/\\\\}"
  s="${s//\"/\\\"}"
  s="${s//$'\n'/\\n}"
  printf '%s' "$s"
}

extract_setting() {
  local file="$1"
  local key="$2"
  awk -v key="\"$key\"" '
    index($0, key) {
      sub(/^[^:]*:[[:space:]]*"/, "", $0)
      sub(/"[[:space:]]*,?[[:space:]]*$/, "", $0)
      print
      exit
    }
  ' "$file"
}

cli_supports_option() {
  local option="$1"
  local help_text="$2"
  [[ "$help_text" == *"$option"* ]]
}

add_code_candidate() {
  local target_name="$1"
  local -n candidates_ref="$target_name"
  local candidate="$2"
  local existing
  for existing in "${candidates_ref[@]}"; do
    if [[ "$existing" == "$candidate" ]]; then
      return 0
    fi
  done
  candidates_ref+=("$candidate")
}

discover_code_candidates() {
  local target_name="$1"
  local -n candidates_ref="$target_name"

  if [[ -n "${NEW_CHAT_CODE_BIN:-}" ]]; then
    add_code_candidate "$target_name" "$NEW_CHAT_CODE_BIN"
    return 0
  fi

  if [[ -x "/mnt/c/Program Files/Microsoft VS Code/bin/code" ]]; then
    add_code_candidate "$target_name" "/mnt/c/Program Files/Microsoft VS Code/bin/code"
  fi
  if [[ -x "/mnt/c/Program Files/Microsoft VS Code Insiders/bin/code-insiders" ]]; then
    add_code_candidate "$target_name" "/mnt/c/Program Files/Microsoft VS Code Insiders/bin/code-insiders"
  fi

  if command -v code >/dev/null 2>&1; then
    add_code_candidate "$target_name" "$(command -v code)"
  fi
  if command -v code-insiders >/dev/null 2>&1; then
    add_code_candidate "$target_name" "$(command -v code-insiders)"
  fi
}

REPOS_ROOT="$(resolve_existing_dir "$HOME/library/repositories" "$HOME/Library/repositories")" || {
  echo "Could not find repositories root. Expected ~/library/repositories or ~/Library/repositories." >&2
  exit 1
}
SCRATCH_ROOT="$(resolve_existing_dir "$HOME/library" "$HOME/Library" "$HOME")"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_SETTINGS_TEMPLATE="$SCRIPT_DIR/../config/new-chat-settings.json"

SETTINGS_TEMPLATE="${NEW_CHAT_SETTINGS_FILE:-}"
if [[ -z "$SETTINGS_TEMPLATE" ]]; then
  if [[ -r "$DEFAULT_SETTINGS_TEMPLATE" ]]; then
    SETTINGS_TEMPLATE="$DEFAULT_SETTINGS_TEMPLATE"
  elif template_dir="$(resolve_existing_dir "$HOME/library/repositories/codex/.vscode" "$HOME/Library/repositories/codex/.vscode")"; then
    SETTINGS_TEMPLATE="$template_dir/settings.json"
  fi
fi

color_theme="Default Dark+"
window_title='CODEX | ${folderName}${separator}${activeEditorShort}'
if [[ -n "$SETTINGS_TEMPLATE" && -r "$SETTINGS_TEMPLATE" ]]; then
  parsed_theme="$(extract_setting "$SETTINGS_TEMPLATE" "workbench.colorTheme" || true)"
  parsed_title="$(extract_setting "$SETTINGS_TEMPLATE" "window.title" || true)"
  if [[ -n "${parsed_theme:-}" ]]; then
    color_theme="$parsed_theme"
  fi
  if [[ -n "${parsed_title:-}" ]]; then
    window_title="$parsed_title"
  fi
fi

target_dir=""
use_isolated_instance=1

while [[ $# -gt 0 ]]; do
  case "$1" in
    --repo)
      [[ $# -ge 2 ]] || { echo "Missing value for --repo." >&2; exit 1; }
      repo_arg="$2"
      shift 2
      if [[ -d "$repo_arg" ]]; then
        target_dir="$(cd "$repo_arg" && pwd)"
      elif [[ -d "$REPOS_ROOT/$repo_arg" ]]; then
        target_dir="$(cd "$REPOS_ROOT/$repo_arg" && pwd)"
      else
        echo "Repo not found: $repo_arg" >&2
        exit 1
      fi
      ;;
    --scratch)
      target_dir="$SCRATCH_ROOT"
      shift
      ;;
    --shared-instance)
      use_isolated_instance=0
      shift
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage >&2
      exit 1
      ;;
  esac
done

if [[ -z "$target_dir" ]]; then
  if [[ ! -t 0 ]]; then
    target_dir="$SCRATCH_ROOT"
  fi
fi

if [[ -z "$target_dir" ]]; then
  mapfile -t repo_names < <(find "$REPOS_ROOT" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | sort -f)

  echo "Select target for new VS Code window:"
  echo "  [0] Scratch ($SCRATCH_ROOT)"
  idx=1
  for repo_name in "${repo_names[@]}"; do
    echo "  [$idx] $repo_name"
    ((idx++))
  done

  read -rp "Choice [0]: " choice
  choice="${choice:-0}"

  if ! [[ "$choice" =~ ^[0-9]+$ ]]; then
    echo "Invalid choice: $choice" >&2
    exit 1
  fi

  if (( choice == 0 )); then
    target_dir="$SCRATCH_ROOT"
  elif (( choice > 0 && choice <= ${#repo_names[@]} )); then
    selected_repo="${repo_names[choice-1]}"
    target_dir="$REPOS_ROOT/$selected_repo"
  else
    echo "Choice out of range: $choice" >&2
    exit 1
  fi
fi

repo_settings_file="$target_dir/.vscode/settings.json"
if [[ -r "$repo_settings_file" ]]; then
  repo_theme="$(extract_setting "$repo_settings_file" "workbench.colorTheme" || true)"
  repo_title="$(extract_setting "$repo_settings_file" "window.title" || true)"
  if [[ -n "${repo_theme:-}" ]]; then
    color_theme="$repo_theme"
  fi
  if [[ -n "${repo_title:-}" ]]; then
    window_title="$repo_title"
  fi
fi

SESSION_ROOT="${XDG_CACHE_HOME:-$HOME/.cache}/new-chat"
if ! mkdir -p "$SESSION_ROOT/sessions" >/dev/null 2>&1; then
  SESSION_ROOT="/tmp/new-chat-${USER:-user}"
  mkdir -p "$SESSION_ROOT/sessions"
fi
find "$SESSION_ROOT/sessions" -mindepth 1 -maxdepth 1 -type d -mtime +7 -exec rm -rf {} + >/dev/null 2>&1 || true

if ! SESSION_DIR="$(mktemp -d "$SESSION_ROOT/sessions/session-XXXXXX" 2>/dev/null)"; then
  SESSION_ROOT="/tmp/new-chat-${USER:-user}"
  mkdir -p "$SESSION_ROOT/sessions"
  SESSION_DIR="$(mktemp -d "$SESSION_ROOT/sessions/session-XXXXXX")"
fi
launch_target="$target_dir"
use_workspace_file=0

# Prefer opening the folder directly so repo .vscode/settings.json applies and Explorer
# shows the repo root at top level. Opt into workspace wrapper when explicitly requested.
if [[ -n "${NEW_CHAT_SETTINGS_FILE:-}" || "${NEW_CHAT_FORCE_WORKSPACE:-0}" == "1" ]]; then
  use_workspace_file=1
fi

if (( use_workspace_file == 1 )); then
  WORKSPACE_FILE="$SESSION_DIR/new-chat.code-workspace"
  workspace_name="$(basename "$target_dir")"
  if [[ -z "$workspace_name" || "$workspace_name" == "/" || "$workspace_name" == "." ]]; then
    workspace_name="Workspace"
  fi
  target_dir_json="$(json_escape "$target_dir")"
  workspace_name_json="$(json_escape "$workspace_name")"
  color_theme_json="$(json_escape "$color_theme")"
  window_title_json="$(json_escape "$window_title")"

  cat >"$WORKSPACE_FILE" <<WORKSPACE
{
  "name": "$workspace_name_json",
  "folders": [
    {
      "path": "$target_dir_json"
    }
  ],
  "settings": {
    "workbench.colorTheme": "$color_theme_json",
    "window.title": "$window_title_json"
  }
}
WORKSPACE
  launch_target="$WORKSPACE_FILE"
fi

code_candidates=()
discover_code_candidates code_candidates

if (( ${#code_candidates[@]} == 0 )); then
  echo "Could not find a VS Code CLI launcher. Set NEW_CHAT_CODE_BIN if needed." >&2
  exit 1
fi

selected_code_bin=""
supports_user_data_dir=0
for candidate in "${code_candidates[@]}"; do
  if candidate_help="$("$candidate" --help 2>&1)"; then
    candidate_supports_user_data_dir=0
    if cli_supports_option "--user-data-dir" "$candidate_help"; then
      candidate_supports_user_data_dir=1
    fi

    if [[ -z "$selected_code_bin" ]]; then
      selected_code_bin="$candidate"
      supports_user_data_dir="$candidate_supports_user_data_dir"
    fi

    if (( use_isolated_instance == 1 && candidate_supports_user_data_dir == 1 )); then
      selected_code_bin="$candidate"
      supports_user_data_dir=1
      break
    fi
  fi
done

if [[ -z "$selected_code_bin" ]]; then
  echo "None of the detected VS Code launchers worked in this environment." >&2
  exit 1
fi

if (( use_isolated_instance == 1 )); then
  if (( supports_user_data_dir == 1 )); then
    mkdir -p "$SESSION_DIR/user-data"
    env -u VSCODE_IPC_HOOK_CLI -u VSCODE_CWD -u TERM_PROGRAM \
      "$selected_code_bin" --new-window --user-data-dir "$SESSION_DIR/user-data" "$launch_target"
  else
    echo "new-chat: selected launcher does not support --user-data-dir; launching shared instance." >&2
    env -u VSCODE_IPC_HOOK_CLI -u VSCODE_CWD -u TERM_PROGRAM \
      "$selected_code_bin" --new-window "$launch_target"
  fi
else
  env -u VSCODE_IPC_HOOK_CLI -u VSCODE_CWD -u TERM_PROGRAM \
    "$selected_code_bin" --new-window "$launch_target"
fi
